<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For My Queen - Our Little Place</title>
    <!-- Load Romantic Fonts from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Alex+Brush&family=Crimson+Text:wght@400;600;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Load Tone.js for background music generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <!-- FIREBASE MODULE IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables exposed for the main script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel
        };
    </script>
    <!-- END FIREBASE MODULE IMPORTS -->

    <style>
        /* --- THEME COLORS --- */
        :root {
            --color-cream: #F5F5DC;    /* Background */
            --color-rose: #800020;     /* Deep Burgundy/Rose */
            --color-gold: #B8860B;     /* Soft Gold */
            --color-charcoal: #36454F; /* Body Text */
        }
        
        /* --- GLOBAL STYLES & LAYOUT --- */
        #heartCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            z-index: 50; 
        }

        body {
            background-color: var(--color-cream);
            color: var(--color-charcoal);
            font-family: 'Crimson Text', serif;
            line-height: 1.7;
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box; /* Crucial for responsive design */
        }
        
        .hidden {
            display: none !important;
        }

        .container {
            max-width: 800px;
            width: 100%;
            margin: 0;
            padding: 40px 20px;
            box-shadow: 0 10px 40px rgba(128, 0, 32, 0.3), 0 0 0 5px var(--color-gold); 
            background-color: white; 
            border-radius: 25px;
            transform: rotateZ(-0.5deg); 
            transition: transform 0.3s ease-in-out, box-shadow 0.5s ease;
            text-align: center;
            position: relative; 
            z-index: 100;
            animation: gentleFloat 15s infinite ease-in-out;
        }
        
        @keyframes gentleFloat {
            0% { transform: translateY(0) rotateZ(-0.5deg); }
            50% { transform: translateY(-5px) rotateZ(0.5deg); }
            100% { transform: translateY(0) rotateZ(-0.5deg); }
        }

        /* --- LOCK SCREEN STYLES --- */
        #lockScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-cream);
            z-index: 300;
        }

        .lock-box {
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        
        /* --- TYPOGRAPHY STYLES --- */
        .main-title {
            font-family: 'Alex Brush', cursive;
            font-size: clamp(3rem, 7vw, 5em); 
            color: var(--color-gold);
            margin-bottom: 5px;
            font-weight: 400;
            /* ... (gradient and shadow styles remain) ... */
            background: linear-gradient(45deg, var(--color-gold), #FFD700, var(--color-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(184, 134, 11, 0.8), 1px 1px 3px rgba(0, 0, 0, 0.1); 
        }

        .section-title {
            font-family: 'Lora', serif;
            font-size: clamp(1.4em, 4vw, 1.7em); /* Responsive font size */
            color: var(--color-rose);
            padding-bottom: 8px;
            margin-top: 40px;
            margin-bottom: 15px;
            text-align: left;
            border-bottom: 4px double var(--color-rose); 
            letter-spacing: 1px;
        }

        .letter-body p {
            text-align: justify;
            margin-bottom: 18px;
            font-size: clamp(1em, 2.5vw, 1.1em); /* Responsive body text */
        }

        /* --- INTERACTIVE ELEMENT STYLING --- */

        .interactive-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* --- MEMORY BOX & NOTE STYLES --- */
        .memory-box {
            /* Container styling */
        }
        
        .memory-input {
            width: calc(100% - 24px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--color-gold);
            border-radius: 5px;
            min-height: 80px;
            resize: vertical;
        }
        
        .memory-submit-btn {
            background-color: var(--color-rose);
            color: white;
            float: right;
            padding: 8px 20px;
            font-size: 1em;
        }
        
        .memory-list {
            margin-top: 50px;
            clear: both;
        }
        
        .memory-item {
            background-color: rgba(184, 134, 11, 0.05);
            border: 1px solid rgba(128, 0, 32, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
            position: relative;
        }
        
        .memory-date {
            font-size: 0.8em;
            color: var(--color-gold);
            display: block;
            margin-top: 5px;
            font-style: italic;
        }

        /* --- COUNTDOWN STYLES --- */
        .countdown-box {
            margin: 40px auto;
            padding: 20px;
            background-color: rgba(184, 134, 11, 0.1);
            border: 2px solid var(--color-gold);
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .countdown-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .countdown-item {
            background-color: var(--color-rose);
            color: white;
            padding: 15px 5px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        
        .countdown-value {
            font-family: 'Lora', serif;
            font-weight: 700;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            line-height: 1;
        }
        
        .countdown-label {
            font-size: clamp(0.7rem, 2vw, 0.9rem);
            opacity: 0.8;
            margin-top: 5px;
            display: block;
        }

        /* --- GALLERY STYLES --- */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .gallery-item {
            background-color: var(--color-cream);
            border: 1px solid var(--color-gold);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(128, 0, 32, 0.1);
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover {
            transform: scale(1.05) rotate(-1deg);
            box-shadow: 0 8px 20px rgba(128, 0, 32, 0.3);
        }

        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            border-bottom: 3px solid var(--color-rose);
        }
        
        .gallery-caption {
            padding: 10px;
            font-size: 0.9em;
            font-style: italic;
            color: var(--color-charcoal);
        }

        /* --- MOBILE RESPONSIVENESS (BREAKPOINT) --- */
        @media (max-width: 640px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px 10px;
            }
            
            .main-title {
                font-size: 3.5em; /* Ensuring it's still large */
            }
            
            .lock-box {
                padding: 20px;
            }

            .lock-box input {
                width: 95%;
            }
            
            #audioToggle {
                width: 40px;
                height: 40px;
                top: 10px;
                right: 10px;
                font-size: 1.1em;
            }

            /* Adjust countdown grid for mobile */
            .countdown-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
            }

            .countdown-item {
                padding: 10px 5px;
            }
        }
        
        /* --- BACKGROUND ANIMATION ELEMENTS (KEEPING PREVIOUSLY ADDED STYLES) --- */
        body::before {
            content: 'üíñ';
            position: fixed;
            top: 10vh;
            left: 5vw;
            font-size: 4em;
            color: var(--color-rose);
            opacity: 0.1;
            animation: fadeHeart 8s infinite alternate;
            pointer-events: none;
            z-index: 1;
        }
        body::after {
            content: '‚ú®';
            position: fixed;
            bottom: 5vh;
            right: 10vw;
            font-size: 3em;
            color: var(--color-gold);
            opacity: 0.15;
            animation: fadeHeart 10s infinite alternate reverse;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes fadeHeart {
            from { opacity: 0.1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <!-- CANVAS FOR PARTICLE EFFECT (Floating Hearts) -->
    <canvas id="heartCanvas"></canvas>
    
    <!-- NEW: FLOATING TEDDY BEAR -->
    <div id="floatingTeddy" class="hidden" style="position: fixed; bottom: 20vh; left: 20vw; font-size: 5em; opacity: 0.1; z-index: 50; animation: gentleFloat 18s infinite ease-in-out reverse;">
        üß∏
    </div>

    <!-- AUDIO TOGGLE BUTTON -->
    <button id="audioToggle" class="interactive-btn" onclick="toggleAudio()">
        <span id="audioIcon">üîá</span>
    </button>

    <!-- PASSWORD LOCK SCREEN -->
    <div id="lockScreen" class="lock-screen">
        <div class="lock-box">
            <h2 class="main-title" style="font-size: 3em;">A Private Message</h2>
            <p style="color: var(--color-charcoal); font-size: 1.1em;">
                "In all the world, there is no heart for me like yours."<br>
                Please enter the secret code to continue:
            </p>
            <input type="password" id="secretCode" placeholder="Enter Code" autofocus>
            <button class="interactive-btn" onclick="checkCode()">Unlock</button>
            <p id="errorMessage" style="color: var(--color-rose); margin-top: 10px; font-weight: bold;" class="hidden">Incorrect code. Try again, my love.</p>
        </div>
    </div>

    <!-- MAIN CONTENT (Initially Hidden) -->
    <div id="mainContent" class="container hidden">
        
        <!-- 1. HEADER / TITLE -->
        <h1 class="main-title">For My Dearest Neha üíñ</h1>
        <h3 class="sub-title">‚Äî Our Little Place, Just for You ‚Äî</h3>
        
        <!-- EMBEDDED SONG PLAYER -->
        <div class="music-player-container">
            <h3 style="font-size: 1.2em; font-family: 'Lora', serif; color: var(--color-rose); margin-bottom: 5px; font-weight: bold;">Our Song: GULABO</h3>
            <p style="font-size: 0.9em; opacity: 0.8;">
                *The song starts at **3 minutes, 56 seconds**. Enjoy this special part!*
            </p>
            <iframe id="userSongPlayer" 
                src=""
                data-src="https://www.youtube.com/embed/tVAfKIyVJ-M?autoplay=1&mute=1&loop=1&playlist=tVAfKIyVJ-M&start=236"
                allow="autoplay; encrypted-media; gyroscope; picture-in-picture"
                title="Our Song"
                frameborder="0" 
                allowfullscreen>
            </iframe>
        </div>
        
        <!-- Opening Quote (E.E. Cummings) -->
        <blockquote class="quote">
            "Yours is the light by which my spirit's born‚Äîyou are my sun, my moon, and all my stars."
        </blockquote>
        
        <!-- 2. THE LOVE LETTER BODY (Content remains the same) -->
        <div class="letter-body">
            
            <h2 class="section-title">üíñ I. The Beginning: Our Journey So Far üíñ</h2>
            <p>
                My darling, I remember the moment our story truly began, not just the date, but the exact instant the world tilted. It wasn't in a grand setting, but during that quiet, rainy afternoon when you were recounting a silly childhood story. The way your eyes crinkled when you laughed, the earnestness in your voice‚Äîit hit me then, a simple, profound truth: you are my home. Since that day, every step we've taken together, from the monumental to the mundane, has felt like the most incredible journey, and I wouldn't trade a single second of it.
            </p>
            
            <h2 class="section-title">‚ù§Ô∏è II. The Qualities: What I Admire Most About You ‚ù§Ô∏è</h2>
            <p>
                The qualities I adore in you run deeper than mere surface affection. I love your quiet resilience; the way you handle setbacks and stress with a graceful determination that inspires around you. You don't just possess kindness, you wield it as a superpower‚ÄîI especially cherish the immense patience and empathy you show towards [e.g., your family, animals, or those in need]. And while your fierce spirit and incredible intelligence captivate me daily, I have to confess that my favorite detail is purely physical: the beautiful, slight tilt of your head when you're thinking deeply about a problem, and the genuine, full-throated joy of your laughter, which truly sounds like music to me.
            </p>

            <h2 class="section-title">‚ú® III. The Comfort: The Feeling of "Home" ‚ú®</h2>
            <p>
                You don't just share my life; you *are* the foundation upon which my life is built. If the world outside is a chaotic storm, you are the quiet harbor where the water is always still. The true feeling of "home" isn't a place, but the profound sense of calm that washes over me the moment I see you, whether we are simply curled up on the sofa watching a movie or navigating a busy day. You give me a sense of belonging and unconditional acceptance that allows me to be completely, unreservedly myself. In your arms, I have finally found my favorite place in the universe.
            </p>

            <h2 class="section-title">üíç IV. The Future: Our Dreams Together üíç</h2>
            <p>
                The future with you isn't just something I look forward to; it‚Äôs the certainty that makes every day worthwhile. My favorite dreams are the simple ones‚Äîthe quiet mornings drinking coffee on a porch, the ridiculous arguments over which movie to watch, and growing old together, witnessing the beautiful story we‚Äôve created unfold over decades. My ultimate goal is simply to be your constant, unshakeable support, to make you laugh every day, and to chase down every single shared adventure, whether that means traveling to [Specific Shared Dream Place] or simply building a life full of cozy routine. You are the destination, and I promise to spend every day making sure you know how loved you are.
            </p>

            <hr class="rose-divider">
        </div>
        
        <!-- 3. SPECIAL COUNTDOWN TIMER (ANNIVERSARY) -->
        <h2 class="section-title">üï∞Ô∏è V. The Next Milestone: Anniversary Countdown üï∞Ô∏è</h2>
        <div class="countdown-box">
            <h4 style="font-family: 'Lora', serif; color: var(--color-rose); margin: 0 0 10px 0;">
                Counting down to our special day: <span id="targetDateDisplay" style="font-weight: bold; color: var(--color-gold);">[Loading Date...]</span>
            </h4>
            <div class="countdown-grid" id="countdownTimer">
                <div class="countdown-item"><div class="countdown-value" id="days">00</div><div class="countdown-label">Days</div></div>
                <div class="countdown-item"><div class="countdown-value" id="hours">00</div><div class="countdown-label">Hours</div></div>
                <div class="countdown-item"><div class="countdown-value" id="minutes">00</div><div class="countdown-label">Minutes</div></div>
                <div class="countdown-item"><div class="countdown-value" id="seconds">00</div><div class="countdown-label">Seconds</div></div>
            </div>
        </div>
        
        <!-- 4. BIRTHDAY COUNTDOWN TIMER - NEW -->
        <h2 class="section-title">üéÇ VI. The Most Important Day: Birthday Countdown üéÇ</h2>
        <div class="countdown-box">
            <h4 style="font-family: 'Lora', serif; color: var(--color-rose); margin: 0 0 10px 0;">
                Counting down to your birthday (Dec 27th): <span id="targetBirthdayDateDisplay" style="font-weight: bold; color: var(--color-gold);">[Loading Date...]</span>
            </h4>
            <div class="countdown-grid" id="countdownBirthdayTimer">
                <div class="countdown-item"><div class="countdown-value" id="b_days">00</div><div class="countdown-label">Days</div></div>
                <div class="countdown-item"><div class="countdown-value" id="b_hours">00</div><div class="countdown-label">Hours</div></div>
                <div class="countdown-item"><div class="countdown-value" id="b_minutes">00</div><div class="countdown-label">Minutes</div></div>
                <div class="countdown-item"><div class="countdown-value" id="b_seconds">00</div><div class="countdown-label">Seconds</div></div>
            </div>
        </div>
        
        <!-- 5. PROMISE SECTION - NEW -->
        <h2 class="section-title">üåü VII. My Promise: The "Best to Best" for Your Happiness üåü</h2>
        <p style="text-align: center; font-style: italic; opacity: 0.9;">
            My guiding principle is your happiness. Here are the promises I make, every day:
        </p>
        <ul style="list-style: none; padding: 0; text-align: left; margin: 20px auto; max-width: 600px;">
            <li style="margin-bottom: 15px; border-left: 3px solid var(--color-rose); padding-left: 15px;">
                <span style="font-weight: bold; color: var(--color-gold);">The Listener:</span> To truly listen‚Äînot just hear words, but understand the feeling behind them, even the quiet thoughts you don't say out loud.
            </li>
            <li style="margin-bottom: 15px; border-left: 3px solid var(--color-rose); padding-left: 15px;">
                <span style="font-weight: bold; color: var(--color-gold);">The Champion:</span> To celebrate every single achievement, no matter how small, and to be your fiercest supporter when you doubt yourself.
            </li>
            <li style="margin-bottom: 15px; border-left: 3px solid var(--color-rose); padding-left: 15px;">
                <span style="font-weight: bold; color: var(--color-gold);">The Comfort:</span> To always make you feel safe, loved, and beautiful, especially on the days when you feel anything less.
            </li>
            <li style="margin-bottom: 15px; border-left: 3px solid var(--color-rose); padding-left: 15px;">
                <span style="font-weight: bold; color: var(--color-gold);">The Adventure Planner:</span> To spontaneously surprise you with things you love‚Äîwhether it's your favorite snack, a perfect movie night setup, or planning that weekend getaway you've been dreaming of.
            </li>
            <li style="margin-bottom: 15px; border-left: 3px solid var(--color-rose); padding-left: 15px;">
                <span style="font-weight: bold; color: var(--color-gold);">The Partner:</span> To be an equal and active partner in our life, handling responsibilities with grace and sharing the load completely.
            </li>
        </ul>


        <!-- 6. PHOTO GALLERY PLACEHOLDERS -->
        <h2 class="section-title">üì∏ VIII. Cherished Memories üì∏</h2>
        <p style="text-align: center; font-style: italic; opacity: 0.9;">
            A few of our favorite moments‚Äîfrom that trip to [City] to that cozy evening on the couch.
        </p>
        <div class="gallery-grid">
            <div class="gallery-item">
                <!-- Placeholder Image 1: Placeholder for that amazing trip -->
                <img src="https://placehold.co/400x300/800020/F5F5DC?text=Trip+Photo" onerror="this.onerror=null; this.src='https://placehold.co/400x300/800020/F5F5DC?text=Trip+Photo'" alt="Placeholder for a travel photo">
                <p class="gallery-caption">Remembering our unforgettable trip to the mountains.</p>
            </div>
            <div class="gallery-item">
                <!-- Placeholder Image 2: Placeholder for a cozy date night -->
                <img src="https://placehold.co/400x300/B8860B/800020?text=Date+Night" onerror="this.onerror=null; this.src='https://placehold.co/400x300/B8860B/800020?text=Date+Night'" alt="Placeholder for a cozy date night">
                <p class="gallery-caption">The night we laughed until we cried.</p>
            </div>
            <div class="gallery-item">
                <!-- Placeholder Image 3: Placeholder for a sweet selfie -->
                <img src="https://placehold.co/400x300/800020/F5F5DC?text=Our+Selfie" onerror="this.onerror=null; this.src='https://placehold.co/400x300/800020/F5F5DC?text=Our+Selfie'" alt="Placeholder for a selfie">
                <p class="gallery-caption">Just a typical Tuesday, but the best one.</p>
            </div>
        </div>
        
        <!-- NEW: 7. DIGITAL GIFTS / TEDDY BOX -->
        <h2 class="section-title">üß∏ IX. A Cuddle Corner üß∏</h2>
        <p style="text-align: center; font-style: italic; opacity: 0.9;">
            Sending you a digital hug! Feel free to leave a note for this furry friend.
        </p>
        <div class="countdown-box" style="margin-bottom: 50px;">
            <div style="font-size: 4em; margin-bottom: 10px;">üß∏</div>
            <p style="font-family: 'Lora', serif; font-weight: 600; color: var(--color-rose);">
                This little teddy bear holds all my cuddles for you.
            </p>
            <textarea id="teddyNoteInput" class="memory-input" placeholder="Say something nice to Teddy..."></textarea>
            <button onclick="saveTeddyNote()" class="interactive-btn memory-submit-btn" style="background-color: var(--color-gold); color: white;">Send Note</button>
            <div id="teddyNotesContainer" class="memory-list" style="margin-top: 50px; text-align: left;">
                <h3 style="font-size: 1.3em; font-family: 'Lora', serif; color: var(--color-rose); margin-bottom: 15px; clear: both;">Teddy's Messages:</h3>
                <!-- Teddy notes will be loaded here -->
                <p style="opacity: 0.7;">Loading Teddy's messages...</p>
            </div>
        </div>
        
        <!-- 8. PRIVATE MEMORY BOX -->
        <div class="memory-box">
            <h2 class="section-title" style="text-align: center; border: none; margin-bottom: 25px;">
                üíå X. Our Private Memory Box
            </h2>
            <p style="text-align: center; font-style: italic; color: var(--color-rose); margin-bottom: 20px;">
                Jot down a beautiful moment, a silly joke, or a cherished memory of Neha. These are stored just for you.
            </p>
            
            <textarea id="memoryInput" class="memory-input" placeholder="What's a sweet memory you want to save?"></textarea>
            <button onclick="saveMemory()" class="interactive-btn memory-submit-btn">Save Memory</button>

            <div class="memory-list">
                <h3 style="font-size: 1.3em; font-family: 'Lora', serif; color: var(--color-rose); margin-bottom: 15px; clear: both;">Saved Moments:</h3>
                <div id="memoriesContainer">
                    <p style="opacity: 0.7;">Loading your treasured memories...</p>
                </div>
            </div>
        </div>
        <!-- END MEMORY BOX -->
        
        <!-- 7. CLOSING AND FOOTER -->
        <p class="closing-signature">
            With all my love, always and forever,<br>
            <span class="signature">Alex</span>
        </p>

        <div class="footer">
            <p>A forever dedication to my one and only love, Neha.</p>
            <div id="userIdDisplay"></div>
        </div>

    </div>

    <script type="module">
        // Import Firebase functions from the window object set by the script module above
        const { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel 
        } = window.firebase;
        
        // --- CONSTANTS AND STATE ---
        const CORRECT_CODE = "NEHA"; 
        // SET YOUR ANNIVERSARY DATE HERE (e.g., December 31, 2026)
        const ANNIVERSARY_DATE = new Date("December 31, 2026 00:00:00").getTime();
        // SET YOUR BIRTHDAY DATE HERE (December 27th)
        const BIRTHDAY_DATE = new Date("December 27, 2025 00:00:00").getTime();
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- AUDIO LOGIC (Tone.js) ---
        let ambientSynth;
        let isMuted = true; // Starts Muted

        function initializeAudio() {
            // Set up a simple ambient pad synth
            ambientSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 4,
                    decay: 0.1,
                    sustain: 1,
                    release: 4
                },
                volume: -40 // Start muted
            }).toDestination();
            
            const reverb = new Tone.Reverb(4).toDestination();
            ambientSynth.connect(reverb);
            
            const notes = ["A3", "C#4", "E4", "G#4"]; 

            new Tone.Loop(time => {
                ambientSynth.triggerAttackRelease(notes, "4n", time);
            }, "2n").start(0);

            Tone.Transport.loop = true;
            Tone.Transport.loopEnd = '4m'; 
            Tone.Transport.start(); // Start the transport scheduler immediately
        }
        
        window.toggleAudio = function() {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            
            isMuted = !isMuted;
            const icon = document.getElementById('audioIcon');
            
            if (isMuted) {
                ambientSynth.volume.rampTo(-40, 0.5); 
                icon.innerText = 'üîá';
            } else {
                ambientSynth.volume.rampTo(-15, 0.5); 
                icon.innerText = 'üîä';
            }
        }

        function playOnUnlock() {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            if (isMuted) {
                isMuted = false;
                document.getElementById('audioIcon').innerText = 'üîä';
            }
            ambientSynth.volume.rampTo(-15, 0.5); 
        }

        // --- PARTICLE LOGIC (The "Crazy" Part) ---
        let canvas, ctx;
        let hearts = [];
        let isAnimationRunning = false;

        class HeartParticle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 8 + 4; 
                this.speedY = Math.random() * 1 + 0.5; 
                this.speedX = Math.random() * 1 - 0.5; 
                this.opacity = Math.random() * 0.8 + 0.5;
                this.color = (Math.random() < 0.5) ? 'rgba(128, 0, 32, ' : 'rgba(184, 134, 11, '; 
            }

            update() {
                this.y += this.speedY;
                this.x += this.speedX + Math.sin(this.y * 0.01) * 0.5;
                this.opacity -= 0.002;
            }

            draw() {
                ctx.fillStyle = this.color + this.opacity + ')';
                ctx.shadowColor = this.color + this.opacity + ')';
                ctx.shadowBlur = this.size / 2;
                
                const radius = this.size / 2;
                ctx.beginPath();
                
                // Drawing simplified heart path
                ctx.moveTo(this.x, this.y + radius * 1.5);
                ctx.bezierCurveTo(this.x + 2 * radius, this.y - radius * 0.5, this.x + radius, this.y - 2 * radius, this.x, this.y - 1.5 * radius);
                ctx.bezierCurveTo(this.x - radius, this.y - 2 * radius, this.x - 2 * radius, this.y - radius * 0.5, this.x, this.y + radius * 1.5);
                
                ctx.closePath();
                ctx.fill();
            }
        }

        function createHearts() {
            if (hearts.length < 100 && Math.random() < 0.3) { 
                 const x = Math.random() * canvas.width;
                 const y = -20;
                 hearts.push(new HeartParticle(x, y));
            }
        }

        function handleParticles() {
            if (!isAnimationRunning) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            createHearts();

            for (let i = 0; i < hearts.length; i++) {
                hearts[i].update();
                hearts[i].draw();
            }

            hearts = hearts.filter(heart => heart.opacity > 0 && heart.y < canvas.height + 50);

            requestAnimationFrame(handleParticles);
        }

        function startParticleAnimation() {
            if (!isAnimationRunning) {
                canvas = document.getElementById('heartCanvas');
                ctx = canvas.getContext('2d');
                isAnimationRunning = true;
                
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                });
                
                handleParticles();
            }
        }
        
        // --- COUNTDOWN LOGIC ---

        function updateTimeDisplay(distance, daysId, hoursId, minutesId, secondsId, timerId, finalMessage) {
            if (distance < 0) {
                document.getElementById(timerId).innerHTML = finalMessage;
                return true;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const formatTime = (t) => String(t).padStart(2, '0');

            document.getElementById(daysId).textContent = formatTime(days);
            document.getElementById(hoursId).textContent = formatTime(hours);
            document.getElementById(minutesId).textContent = formatTime(minutes);
            document.getElementById(secondsId).textContent = formatTime(seconds);
            return false;
        }

        function startCountdown() {
            document.getElementById('targetDateDisplay').textContent = new Date(ANNIVERSARY_DATE).toLocaleDateString();
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = ANNIVERSARY_DATE - now;
                
                if (updateTimeDisplay(distance, 'days', 'hours', 'minutes', 'seconds', 'countdownTimer', '<h3 style="color: var(--color-rose);">üíñ Our Anniversary is TODAY! üíñ</h3>')) {
                    clearInterval(interval);
                }
            }, 1000);
        }
        
        function startBirthdayCountdown() {
            document.getElementById('targetBirthdayDateDisplay').textContent = new Date(BIRTHDAY_DATE).toLocaleDateString();
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = BIRTHDAY_DATE - now;
                
                if (updateTimeDisplay(distance, 'b_days', 'b_hours', 'b_minutes', 'b_seconds', 'countdownBirthdayTimer', '<h3 style="color: var(--color-rose);">üéÇ Happy Birthday, My Queen! üéÇ</h3>')) {
                    clearInterval(interval);
                }
            }, 1000);
        }

        // --- FIREBASE INITIALIZATION & DATA FUNCTIONS ---

        // Generic collection reference getter
        function getCollectionRef(collectionName) {
            if (!db || !userId) {
                console.error("Firestore or User ID is not available.");
                return null;
            }
            // Private path: /artifacts/{appId}/users/{userId}/{collectionName}
            const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
            return collection(db, path);
        }
        
        // Generic renderer for notes/memories
        function renderNotes(notes, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (notes.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7; font-style: italic;">No notes saved yet. Add the first one!</p>';
                return;
            }
            
            notes.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            notes.forEach(note => {
                const date = note.timestamp 
                    ? new Date(note.timestamp.seconds * 1000).toLocaleString() 
                    : 'Just now';
                
                const item = document.createElement('div');
                item.className = 'memory-item';
                item.innerHTML = `
                    <p style="margin: 0; white-space: pre-wrap;">${note.text}</p>
                    <span class="memory-date">Saved: ${date}</span>
                `;
                container.appendChild(item);
            });
        }
        
        function loadMemories() {
            const memoriesRef = getCollectionRef('memories');
            if (!memoriesRef) return;

            onSnapshot(memoriesRef, (snapshot) => {
                const memories = [];
                snapshot.forEach(doc => {
                    memories.push(doc.data());
                });
                renderNotes(memories, 'memoriesContainer');
            }, (error) => {
                console.error("Error loading memories:", error);
                document.getElementById('memoriesContainer').innerHTML = '<p style="color: var(--color-rose);">Could not load memories. Please check console for errors.</p>';
            });
        }
        
        function loadTeddyNotes() {
            const notesRef = getCollectionRef('teddy_notes');
            if (!notesRef) return;

            onSnapshot(notesRef, (snapshot) => {
                const notes = [];
                snapshot.forEach(doc => {
                    notes.push(doc.data());
                });
                renderNotes(notes, 'teddyNotesContainer');
            }, (error) => {
                console.error("Error loading teddy notes:", error);
                document.getElementById('teddyNotesContainer').innerHTML = '<p style="color: var(--color-rose);">Could not load notes for Teddy. Please check console for errors.</p>';
            });
        }


        window.saveMemory = async function() {
            const input = document.getElementById('memoryInput');
            const memoryText = input.value.trim();

            if (!memoryText) {
                console.error("Please write a memory before saving!");
                return;
            }

            const memoriesRef = getCollectionRef('memories');
            if (!memoriesRef) return;

            try {
                await addDoc(memoriesRef, {
                    text: memoryText,
                    timestamp: serverTimestamp()
                });
                input.value = '';
                console.log("Memory saved successfully.");
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }
        
        window.saveTeddyNote = async function() {
            const input = document.getElementById('teddyNoteInput');
            const noteText = input.value.trim();

            if (!noteText) {
                console.error("Please write a note before sending!");
                return;
            }

            const notesRef = getCollectionRef('teddy_notes');
            if (!notesRef) return;

            try {
                await addDoc(notesRef, {
                    text: noteText,
                    timestamp: serverTimestamp()
                });
                input.value = '';
                console.log("Teddy note saved successfully.");
            } catch (e) {
                console.error("Error adding teddy note: ", e);
            }
        }

        async function initializeAppAndAuth() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    } catch (e) {
                        userId = crypto.randomUUID(); 
                        console.error("Anonymous sign-in failed, using random ID:", e);
                    }
                }
                
                isAuthReady = true;
                document.getElementById('userIdDisplay').innerText = `App ID: ${appId} | User ID: ${userId}`;
                
                if (document.getElementById('mainContent').classList.contains('hidden') === false) {
                    loadMemories();
                    loadTeddyNotes(); 
                }
            });

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch(error) {
                console.error("Firebase initial sign-in failed:", error);
            }
        }
        
        // --- PAGE LOGIC ---
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndAuth();
            initializeAudio(); 
        });

        window.checkCode = async function() {
            const input = document.getElementById('secretCode').value.toUpperCase().trim();
            const error = document.getElementById('errorMessage');

            if (input === CORRECT_CODE) {
                // Success: hide lock screen and show content
                document.getElementById('lockScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('floatingTeddy').classList.remove('hidden'); // UNHIDE TEDDY
                localStorage.setItem('love_site_unlocked', 'true');
                
                // Start new features
                startParticleAnimation(); 
                playOnUnlock(); 
                startCountdown(); 
                startBirthdayCountdown(); // START BIRTHDAY COUNTDOWN
                
                // Load and autoplay the song player
                const player = document.getElementById('userSongPlayer');
                if (player) {
                    const src = player.getAttribute('data-src');
                    player.src = src; 
                }

                if (isAuthReady) {
                    loadMemories();
                    loadTeddyNotes(); 
                }

            } else {
                // Failure: show error message
                error.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>